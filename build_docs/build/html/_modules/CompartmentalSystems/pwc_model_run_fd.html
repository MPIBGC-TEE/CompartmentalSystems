
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CompartmentalSystems.pwc_model_run_fd &#8212; CompartmentalSystems 1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for CompartmentalSystems.pwc_model_run_fd</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">pinv</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">expm</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Matrix</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">Symbol</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">.model_run</span> <span class="kn">import</span> <span class="n">ModelRun</span>
<span class="kn">from</span> <span class="nn">.pwc_model_run</span> <span class="kn">import</span> <span class="n">PWCModelRun</span>
<span class="kn">from</span> <span class="nn">.smooth_reservoir_model</span> <span class="kn">import</span> <span class="n">SmoothReservoirModel</span>
<span class="kn">from</span> <span class="nn">.myOdeResult</span> <span class="kn">import</span> <span class="n">solve_ivp_pwc</span>
<span class="c1"># from bgc_md2.Variable import Variable</span>

<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="PWCModelRunFDError"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFDError">[docs]</a><span class="k">class</span> <span class="nc">PWCModelRunFDError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic error occurring in this module.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="PWCModelRunFD"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD">[docs]</a><span class="k">class</span> <span class="nc">PWCModelRunFD</span><span class="p">(</span><span class="n">ModelRun</span><span class="p">):</span>
<span class="c1">#    def __init__(</span>
<span class="c1">#        self,</span>
<span class="c1">#        time_symbol,</span>
<span class="c1">#        data_times,</span>
<span class="c1">#        start_values,</span>
<span class="c1">#        gross_Us,</span>
<span class="c1">#        gross_Fs,</span>
<span class="c1">#        gross_Rs</span>
<span class="c1">#    ):</span>
<span class="c1">#</span>
<span class="c1">#        self.data_times = data_times</span>
<span class="c1">#        cls = self.__class__</span>
<span class="c1">#        disc_times = data_times[1:-1]</span>
<span class="c1">#</span>
<span class="c1">#        print(&#39;reconstructing us&#39;)</span>
<span class="c1">##        us = cls.reconstruct_us(data_times, gross_Us)</span>
<span class="c1">##        self.dts = np.diff(self.data_times).astype(np.float64)</span>
<span class="c1">#        us = gross_Us / self.dts.reshape(-1, 1)</span>
<span class="c1">#</span>
<span class="c1">#        print(&#39;reconstructing Bs&#39;)</span>
<span class="c1">#        Bs = cls.reconstruct_Bs(</span>
<span class="c1">#            data_times,</span>
<span class="c1">#            start_values,</span>
<span class="c1">#            gross_Us,</span>
<span class="c1">#            gross_Fs,</span>
<span class="c1">#            gross_Rs</span>
<span class="c1">#        )</span>
<span class="c1">#</span>
<span class="c1">#        </span>
<span class="c1">#</span>
<span class="c1">#        nr_pools = len(start_values)</span>
<span class="c1">#        strlen = len(str(nr_pools))</span>
<span class="c1">#</span>
<span class="c1">#        def pool_str(i): return (&quot;{:0&quot;+str(strlen)+&quot;d}&quot;).format(i)</span>
<span class="c1">#        par_dicts = [dict()] * len(us)</span>
<span class="c1">#</span>
<span class="c1">#        srm_generic = cls.create_srm_generic(</span>
<span class="c1">#            time_symbol,</span>
<span class="c1">#            Bs,</span>
<span class="c1">#            us</span>
<span class="c1">#        )</span>
<span class="c1">#        time_symbol = srm_generic.time_symbol</span>
<span class="c1">#</span>
<span class="c1">#        par_dicts = []</span>
<span class="c1">#        for k in range(len(us)):</span>
<span class="c1">#            par_dict = dict()</span>
<span class="c1">#            for j in range(nr_pools):</span>
<span class="c1">#                for i in range(nr_pools):</span>
<span class="c1">#                    sym = Symbol(&#39;b_&#39;+pool_str(i)+pool_str(j))</span>
<span class="c1">#                    if sym in srm_generic.F.free_symbols:</span>
<span class="c1">#                        par_dict[sym] = Bs[k, i, j]</span>
<span class="c1">#</span>
<span class="c1">#            for i in range(nr_pools):</span>
<span class="c1">#                sym = Symbol(&#39;u_&#39;+pool_str(i))</span>
<span class="c1">#                if sym in srm_generic.F.free_symbols:</span>
<span class="c1">#                    par_dict[sym] = us[k, i]</span>
<span class="c1">#</span>
<span class="c1">#            par_dicts.append(par_dict)</span>
<span class="c1">#</span>
<span class="c1">#        func_dicts = [dict()] * len(us)</span>
<span class="c1">#</span>
<span class="c1">#        self.pwc_mr = PWCModelRun(</span>
<span class="c1">#            srm_generic,</span>
<span class="c1">#            par_dicts,</span>
<span class="c1">#            start_values,</span>
<span class="c1">#            data_times,</span>
<span class="c1">#            func_dicts=func_dicts,</span>
<span class="c1">#            disc_times=disc_times</span>
<span class="c1">#        )</span>
<span class="c1">#        self.us = us</span>
<span class="c1">#        self.Bs = Bs</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Bs</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">pwc_mr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_times</span> <span class="o">=</span> <span class="n">pwc_mr</span><span class="o">.</span><span class="n">times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span> <span class="o">=</span> <span class="n">pwc_mr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bs</span> <span class="o">=</span> <span class="n">Bs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">us</span> <span class="o">=</span> <span class="n">us</span>

<div class="viewcode-block" id="PWCModelRunFD.from_Bs_and_us"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.from_Bs_and_us">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_Bs_and_us</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">time_symbol</span><span class="p">,</span> <span class="n">data_times</span><span class="p">,</span> <span class="n">start_values</span><span class="p">,</span> <span class="n">Bs</span><span class="p">,</span> <span class="n">us</span><span class="p">):</span>
        <span class="n">disc_times</span> <span class="o">=</span> <span class="n">data_times</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">nr_pools</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>
        <span class="n">strlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> 
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{:0&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strlen</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">par_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">us</span><span class="p">)</span>

        <span class="n">srm_generic</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_srm_generic</span><span class="p">(</span>
            <span class="n">time_symbol</span><span class="p">,</span>
            <span class="n">Bs</span><span class="p">,</span>
            <span class="n">us</span>
        <span class="p">)</span>

        <span class="n">par_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">us</span><span class="p">)):</span>
            <span class="n">par_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;b_&#39;</span><span class="o">+</span><span class="n">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">pool_str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">srm_generic</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">:</span>
                        <span class="n">par_dict</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;u_&#39;</span><span class="o">+</span><span class="n">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">srm_generic</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">:</span>
                    <span class="n">par_dict</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">us</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

            <span class="n">par_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_dict</span><span class="p">)</span>

        <span class="n">func_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">us</span><span class="p">)</span>

        <span class="n">pwc_mr</span> <span class="o">=</span> <span class="n">PWCModelRun</span><span class="p">(</span>
            <span class="n">srm_generic</span><span class="p">,</span>
            <span class="n">par_dicts</span><span class="p">,</span>
            <span class="n">start_values</span><span class="p">,</span>
            <span class="n">data_times</span><span class="p">,</span>
            <span class="n">func_dicts</span><span class="o">=</span><span class="n">func_dicts</span><span class="p">,</span>
            <span class="n">disc_times</span><span class="o">=</span><span class="n">disc_times</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">Bs</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">pwc_mr</span><span class="p">)</span></div>

<div class="viewcode-block" id="PWCModelRunFD.from_gross_fluxes"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.from_gross_fluxes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_gross_fluxes</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">time_symbol</span><span class="p">,</span>
        <span class="n">data_times</span><span class="p">,</span>
        <span class="n">start_values</span><span class="p">,</span>
        <span class="n">gross_Us</span><span class="p">,</span>
        <span class="n">gross_Fs</span><span class="p">,</span>
        <span class="n">gross_Rs</span>
    <span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reconstructing us&#39;</span><span class="p">)</span>
        <span class="n">dts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data_times</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">us</span> <span class="o">=</span> <span class="n">gross_Us</span> <span class="o">/</span> <span class="n">dts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reconstructing Bs&#39;</span><span class="p">)</span>
        <span class="n">Bs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">reconstruct_Bs</span><span class="p">(</span>
            <span class="n">data_times</span><span class="p">,</span>
            <span class="n">start_values</span><span class="p">,</span>
            <span class="n">gross_Us</span><span class="p">,</span>
            <span class="n">gross_Fs</span><span class="p">,</span>
            <span class="n">gross_Rs</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_Bs_and_us</span><span class="p">(</span>
            <span class="n">time_symbol</span><span class="p">,</span>
            <span class="n">data_times</span><span class="p">,</span>
            <span class="n">start_values</span><span class="p">,</span>
            <span class="n">Bs</span><span class="p">,</span>
            <span class="n">us</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">model</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nr_pools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">nr_pools</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_times</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">start_values</span>

<div class="viewcode-block" id="PWCModelRunFD.solve"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alternative_start_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">alternative_start_values</span><span class="p">)</span></div>

<div class="viewcode-block" id="PWCModelRunFD.B_func"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.B_func">[docs]</a>    <span class="k">def</span> <span class="nf">B_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec_sol_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">B_func</span><span class="p">(</span><span class="n">vec_sol_func</span><span class="p">)</span></div>

<div class="viewcode-block" id="PWCModelRunFD.external_input_vector_func"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.external_input_vector_func">[docs]</a>    <span class="k">def</span> <span class="nf">external_input_vector_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_off</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">external_input_vector_func</span><span class="p">(</span><span class="n">cut_off</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_times</span>

<div class="viewcode-block" id="PWCModelRunFD.acc_gross_external_input_vector"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.acc_gross_external_input_vector">[docs]</a>    <span class="k">def</span> <span class="nf">acc_gross_external_input_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">us</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="PWCModelRunFD.acc_gross_internal_flux_matrix"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.acc_gross_internal_flux_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">acc_gross_internal_flux_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">acc_gross_internal_flux_matrix</span><span class="p">()</span></div>

<div class="viewcode-block" id="PWCModelRunFD.acc_gross_external_output_vector"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.acc_gross_external_output_vector">[docs]</a>    <span class="k">def</span> <span class="nf">acc_gross_external_output_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">acc_gross_external_output_vector</span><span class="p">()</span></div>

<div class="viewcode-block" id="PWCModelRunFD.acc_net_external_input_vector"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.acc_net_external_input_vector">[docs]</a>    <span class="k">def</span> <span class="nf">acc_net_external_input_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">acc_net_external_input_vector</span><span class="p">()</span></div>

<div class="viewcode-block" id="PWCModelRunFD.acc_net_internal_flux_matrix"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.acc_net_internal_flux_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">acc_net_internal_flux_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">acc_net_internal_flux_matrix</span><span class="p">()</span></div>

<div class="viewcode-block" id="PWCModelRunFD.acc_net_external_output_vector"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.acc_net_external_output_vector">[docs]</a>    <span class="k">def</span> <span class="nf">acc_net_external_output_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">acc_net_external_output_vector</span><span class="p">()</span></div>

<div class="viewcode-block" id="PWCModelRunFD.fake_discretized_Bs"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.fake_discretized_Bs">[docs]</a>    <span class="k">def</span> <span class="nf">fake_discretized_Bs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_times</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwc_mr</span><span class="o">.</span><span class="n">fake_discretized_Bs</span><span class="p">(</span><span class="n">data_times</span><span class="p">)</span></div>

<span class="c1">#    def to_netcdf(self, mdo, file_path):</span>
<span class="c1">#        &quot;&quot;&quot;Return a netCDF dataset that contains stocks and fluxes.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#        data_vars = {}</span>
<span class="c1">#        model_ds = xr.Dataset(</span>
<span class="c1">#            data_vars=data_vars,</span>
<span class="c1">#            coords=coords,</span>
<span class="c1">#            attr=attrs</span>
<span class="c1">#        }</span>
<span class="c1">#        model_ds.to_netcdf(file_path)</span>
<span class="c1">#        model_ds.close()</span>
<span class="c1">#</span>
<span class="c1">#    @classmethod</span>
<span class="c1">#    def load_from_file(cls, filename):</span>
<span class="c1">#        pwc_mr_fd_dict = picklegzip.load(filename)</span>
<span class="c1">#</span>
<span class="c1">#        return cls.load_from_dict(pwc_mr_fd_dict)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#    def save_to_file(self, filename):</span>
<span class="c1">#        soln = self.solve()</span>
<span class="c1">#        self.soln = soln</span>
<span class="c1">##        pwc_mr = self.to_smooth_model_run()</span>
<span class="c1">##        soln1 = pwc_mr.solve()</span>
<span class="c1">##        self.soln1 = soln1</span>
<span class="c1">##        soln2, soln2_func = pwc_mr.solve_2()</span>
<span class="c1">##        self.soln2 = soln2</span>
<span class="c1">#        pwc_mr_fd_dict = {</span>
<span class="c1">#            &#39;start_values&#39;: self.start_values,</span>
<span class="c1">#            &#39;time_symbol&#39;:  self.model.time_symbol,</span>
<span class="c1">#            &#39;Bs&#39;:           self.Bs,</span>
<span class="c1">#            &#39;us&#39;:           self.us,</span>
<span class="c1">#            &#39;data_times&#39;:   self.data_times,</span>
<span class="c1">##            &#39;times&#39;:        self.times</span>
<span class="c1">#            &#39;soln&#39;:         soln,</span>
<span class="c1">##            &#39;soln1&#39;:        soln1,</span>
<span class="c1">##            &#39;soln2&#39;:        soln2,</span>
<span class="c1">#            &#39;location&#39;:     getattr(self, &#39;location&#39;, None)</span>
<span class="c1">#        }</span>
<span class="c1">#</span>
<span class="c1">#        picklegzip.dump(pwc_mr_fd_dict, filename)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#    def to_smooth_model_run(self):</span>
<span class="c1">#        smr = SmoothModelRun(</span>
<span class="c1">#            self.model,</span>
<span class="c1">#            self.parameter_set,</span>
<span class="c1">#            self.start_values,</span>
<span class="c1">#            self.data_times,</span>
<span class="c1">#            self.func_set</span>
<span class="c1">#        )</span>
<span class="c1">#</span>
<span class="c1">#        return smr</span>
<span class="c1">#</span>
<span class="c1">#</span>

<div class="viewcode-block" id="PWCModelRunFD.reconstruct_B_surrogate"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.reconstruct_B_surrogate">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reconstruct_B_surrogate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">gross_U</span><span class="p">,</span> <span class="n">gross_F</span><span class="p">,</span> <span class="n">gross_R</span><span class="p">,</span> <span class="n">B0</span><span class="p">):</span>
        <span class="c1"># reconstruct a B that meets F and r possibly well,</span>
        <span class="c1"># B0 is some initial guess for the optimization</span>
        <span class="n">nr_pools</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">gross_u</span> <span class="o">=</span> <span class="n">gross_U</span><span class="o">/</span><span class="n">dt</span>

        <span class="k">def</span> <span class="nf">x_tau</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">expm</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">B</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">M</span> <span class="o">@</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">pinv</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">)</span><span class="o">+</span><span class="n">M</span><span class="p">)</span> <span class="o">@</span> <span class="n">gross_u</span>

        <span class="c1"># integrate x</span>
        <span class="k">def</span> <span class="nf">integrate_x</span><span class="p">(</span><span class="n">tr_times</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">rhs</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">x_tau</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

<span class="c1">#            xs = np.array(list(map(x, tr_times))), x(tr_times[-1])</span>
<span class="c1">#            int_x np.trapz(xs, tr_times, axis=0)</span>
            <span class="n">int_x</span> <span class="o">=</span> <span class="n">solve_ivp_pwc</span><span class="p">(</span>
                <span class="n">rhss</span><span class="o">=</span><span class="p">[</span><span class="n">rhs</span><span class="p">],</span>
                <span class="n">t_span</span><span class="o">=</span><span class="p">(</span><span class="n">tr_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tr_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">y0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">int_x</span>

        <span class="c1"># convert parameter vector to compartmental matrix</span>
        <span class="k">def</span> <span class="nf">pars_to_matrix</span><span class="p">(</span><span class="n">pars</span><span class="p">):</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">B</span><span class="p">[</span><span class="n">int_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">int_indices</span><span class="p">)]</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nr_pools</span><span class="p">,</span> <span class="n">nr_pools</span><span class="p">))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[(</span><span class="n">ext_indices</span><span class="o">-</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span> <span class="o">+=</span> <span class="n">pars</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">int_indices</span><span class="p">):]</span>
            <span class="n">B</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span>

            <span class="k">return</span> <span class="n">B</span>

        <span class="c1"># function to minimize difference vector of</span>
        <span class="c1"># internal fluxes F and outfluxes r</span>
        <span class="k">def</span> <span class="nf">g_tr</span><span class="p">(</span><span class="n">pars</span><span class="p">):</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">pars_to_matrix</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
<span class="c1">#            tr_times = np.linspace(0, dt, 11)</span>
            <span class="n">tr_times</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
            <span class="n">int_x</span> <span class="o">=</span> <span class="n">integrate_x</span><span class="p">(</span><span class="n">tr_times</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

            <span class="n">res1_int</span> <span class="o">=</span> <span class="n">gross_F</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="p">,))[</span><span class="n">int_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">res2_int</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">int_indices</span><span class="p">)]</span> \
                <span class="o">*</span> <span class="n">int_x</span><span class="p">[(</span><span class="n">int_indices</span> <span class="o">%</span> <span class="n">nr_pools</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">res_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">res1_int</span><span class="o">-</span><span class="n">res2_int</span><span class="p">)</span>

            <span class="n">res1_ext</span> <span class="o">=</span> <span class="n">gross_R</span><span class="p">[(</span><span class="n">ext_indices</span><span class="o">-</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">res2_ext</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">int_indices</span><span class="p">):]</span>\
                <span class="o">*</span> <span class="n">int_x</span><span class="p">[(</span><span class="n">ext_indices</span><span class="o">-</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">res_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">res1_ext</span><span class="o">-</span><span class="n">res2_ext</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_int</span><span class="p">,</span> <span class="n">res_ext</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># wrapper around g_tr that keeps parameter within boundaries</span>
        <span class="k">def</span> <span class="nf">constrainedFunction</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">minIncr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>

            <span class="n">xBorder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">xBorder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">xBorder</span><span class="p">)</span>
            <span class="n">fBorder</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">xBorder</span><span class="p">)</span>
            <span class="n">distFromBorder</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">,</span> <span class="n">lower</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="n">upper</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">fBorder</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">fBorder</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fBorder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">minIncr</span><span class="p">,</span> <span class="o">-</span><span class="n">minIncr</span><span class="p">)</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="n">distFromBorder</span>
                    <span class="p">)</span>

        <span class="n">lbounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nr_pools</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
            <span class="n">lbounds</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">nr_pools</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

        <span class="n">ubounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nr_pools</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
            <span class="n">ubounds</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">nr_pools</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">par_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gross_F</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">par_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">nr_pools</span><span class="o">+</span><span class="n">j</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gross_R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">par_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>

        <span class="n">par_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">par_indices</span><span class="p">)</span>
        <span class="n">int_indices</span> <span class="o">=</span> <span class="n">par_indices</span><span class="p">[</span><span class="n">par_indices</span> <span class="o">&lt;</span> <span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ext_indices</span> <span class="o">=</span> <span class="n">par_indices</span><span class="p">[</span><span class="n">par_indices</span> <span class="o">&gt;=</span> <span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">lbounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lbounds</span><span class="p">)[</span><span class="n">par_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="n">ubounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ubounds</span><span class="p">)[</span><span class="n">par_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B0</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nr_pools</span><span class="o">**</span><span class="mi">2</span><span class="p">,)),</span> <span class="o">-</span><span class="n">B0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">pars0</span> <span class="o">=</span> <span class="n">A0</span><span class="p">[</span><span class="n">par_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span>
            <span class="n">constrainedFunction</span><span class="p">,</span>
            <span class="n">x0</span><span class="o">=</span><span class="n">pars0</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">g_tr</span><span class="p">,</span> <span class="n">lbounds</span><span class="p">,</span> <span class="n">ubounds</span><span class="p">)</span>
        <span class="p">)</span>

<span class="c1">#        y = least_squares(</span>
<span class="c1">#            g_tr,</span>
<span class="c1">#            x0      = pars0,</span>
<span class="c1">#            verbose = 2,</span>
<span class="c1">##            xtol    = 1e-03,</span>
<span class="c1">#            bounds  = (lbounds, ubounds)</span>
<span class="c1">#        )</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">y</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="n">PWCModelRunFDError</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">pars_to_matrix</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x1</span> <span class="o">=</span> <span class="n">x_tau</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">B</span><span class="p">,</span> <span class="n">x1</span></div>

<div class="viewcode-block" id="PWCModelRunFD.reconstruct_Bs"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.reconstruct_Bs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reconstruct_Bs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">start_values</span><span class="p">,</span> <span class="n">gross_Us</span><span class="p">,</span> <span class="n">gross_Fs</span><span class="p">,</span> <span class="n">gross_Rs</span><span class="p">):</span>
        <span class="n">nr_pools</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_values</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">guess_B0</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">x_approx</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">nr_pools</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_approx</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">)</span>

            <span class="c1"># construct off-diagonals</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">x_approx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">B</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">x_approx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">dt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">B</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># construct diagonals</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">x_approx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">B</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">x_approx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">return</span> <span class="n">B</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">start_values</span>
        <span class="n">Bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr_pools</span><span class="p">,</span> <span class="n">nr_pools</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="c1">#            B0 = guess_B0(dt, (xs[k]+xs[k+1])/2, gross_Fs[k], gross_Rs[k])</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">guess_B0</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">gross_Fs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">gross_Rs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">B</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">reconstruct_B_surrogate</span><span class="p">(</span>
                <span class="n">dt</span><span class="p">,</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">gross_Us</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                <span class="n">gross_Fs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                <span class="n">gross_Rs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                <span class="n">B0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">Bs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">B</span>

        <span class="k">return</span> <span class="n">Bs</span></div>

<div class="viewcode-block" id="PWCModelRunFD.B_pwc"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.B_pwc">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">B_pwc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">Bs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">func_maker</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">times</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">Bs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Bs</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="n">nr_pools</span> <span class="o">=</span> <span class="n">Bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">B_funcs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
                <span class="n">B_funcs</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">func_maker</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">B_funcs</span></div>

<span class="c1">#    @classmethod</span>
<span class="c1">#    def reconstruct_u(cls, dt, data_U):</span>
<span class="c1">#        return data_U / dt</span>
<span class="c1">#</span>
<span class="c1">#    @classmethod</span>
<span class="c1">#    def reconstruct_us(cls, times, gross_Us):</span>
<span class="c1">#        us = np.zeros_like(gross_Us)</span>
<span class="c1">#        for k in range(len(times)-1):</span>
<span class="c1">#            #dt = times[k+1] - times[k]</span>
<span class="c1">#</span>
<span class="c1">#            #dt = dt.item().days ##### to be removed or made safe</span>
<span class="c1">#            us[k,:] = cls.reconstruct_u(self.dts[k], gross_Us[k])</span>
<span class="c1">#</span>
<span class="c1">#        return us</span>

<div class="viewcode-block" id="PWCModelRunFD.u_pwc"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.u_pwc">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">u_pwc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">us</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">func_maker</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">times</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">us</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">us</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="n">nr_pools</span> <span class="o">=</span> <span class="n">us</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u_funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
            <span class="n">u_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_maker</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">u_funcs</span></div>

<div class="viewcode-block" id="PWCModelRunFD.create_B_generic"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.create_B_generic">[docs]</a>    <span class="nd">@classmethod</span>
<span class="c1">#    def create_B_generic(cls, Bs, time_symbol):</span>
    <span class="k">def</span> <span class="nf">create_B_generic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Bs</span><span class="p">):</span>
        <span class="n">nr_pools</span> <span class="o">=</span> <span class="n">Bs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">strlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{:0&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strlen</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">is_constant_Bs</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">Bs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">Bs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Bs</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="n">res</span>

        <span class="n">B_generic</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">,</span> <span class="n">nr_pools</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_constant_Bs</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
                    <span class="c1"># B_generic[i,j] = \</span>
                    <span class="c1">#     Function(&#39;b_&#39;+pool_str(i)+pool_str(j))(time_symbol)</span>
                    <span class="n">B_generic</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;b_&#39;</span><span class="o">+</span><span class="n">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">pool_str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">B_generic</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">B_generic</span></div>

<div class="viewcode-block" id="PWCModelRunFD.create_u_generic"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.create_u_generic">[docs]</a>    <span class="nd">@classmethod</span>
<span class="c1">#    def create_u_generic(cls, us, time_symbol):</span>
    <span class="k">def</span> <span class="nf">create_u_generic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">us</span><span class="p">):</span>
        <span class="n">nr_pools</span> <span class="o">=</span> <span class="n">us</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">strlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{:0&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strlen</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">is_constant_us</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">us</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">us</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">us</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="n">res</span>

        <span class="n">u_generic</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_constant_us</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="c1"># u_generic[i] = Function(&#39;u_&#39;+pool_str(i))(time_symbol)</span>
                <span class="n">u_generic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;u_&#39;</span><span class="o">+</span><span class="n">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u_generic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">us</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">u_generic</span></div>

<div class="viewcode-block" id="PWCModelRunFD.create_srm_generic"><a class="viewcode-back" href="../../CompartmentalSystems.html#CompartmentalSystems.pwc_model_run_fd.PWCModelRunFD.create_srm_generic">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_srm_generic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">time_symbol</span><span class="p">,</span> <span class="n">Bs</span><span class="p">,</span> <span class="n">us</span><span class="p">):</span>
        <span class="n">nr_pools</span> <span class="o">=</span> <span class="n">Bs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">strlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{:0&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strlen</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">state_vector_generic</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span>
            <span class="n">nr_pools</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="p">[</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;x_&#39;</span><span class="o">+</span><span class="n">pool_str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">)]</span>
        <span class="p">)</span>

<span class="c1">#        B_generic = cls.create_B_generic(Bs, time_symbol)</span>
<span class="c1">#        u_generic = cls.create_u_generic(us, time_symbol)</span>
        <span class="n">B_generic</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_B_generic</span><span class="p">(</span><span class="n">Bs</span><span class="p">)</span>
        <span class="n">u_generic</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_u_generic</span><span class="p">(</span><span class="n">us</span><span class="p">)</span>

        <span class="n">srm_generic</span> <span class="o">=</span> <span class="n">SmoothReservoirModel</span><span class="o">.</span><span class="n">from_B_u</span><span class="p">(</span>
            <span class="n">state_vector_generic</span><span class="p">,</span>
            <span class="n">time_symbol</span><span class="p">,</span>
            <span class="n">B_generic</span><span class="p">,</span>
            <span class="n">u_generic</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">srm_generic</span></div></div>

<span class="c1">#    def solve(self):</span>
<span class="c1">#        if not hasattr(self, &#39;soln&#39;):</span>
<span class="c1">#            soln = self.pwc_mrs[0].solve()</span>
<span class="c1">#            for k in range(1, len(self.data_times)-1):</span>
<span class="c1">#                soln = soln[:-1]</span>
<span class="c1">#                k_soln = self.pwc_mrs[k].solve()</span>
<span class="c1">#                soln = np.concatenate((soln, k_soln), axis=0)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#            soln = custom_solve_ivp</span>
<span class="c1">#            self.soln = soln</span>
<span class="c1">#</span>
<span class="c1">#        return self.soln</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#    ## which model would be reasonable??</span>
<span class="c1">#    ## here we try to find B and u to match xss</span>
<span class="c1">#    ## potentiallypotentially  very ill-conditioned</span>
<span class="c1">#</span>
<span class="c1">##    def find_equilibrium_model(self, xss, B0, u0):</span>
<span class="c1">##        B = self.model.compartmental_matrix</span>
<span class="c1">##        u = self.model.external_inputs</span>
<span class="c1">##</span>
<span class="c1">##        nr_pools = self.model.nr_pools</span>
<span class="c1">##</span>
<span class="c1">##        ## convert parameter vector to compartmental matrix</span>
<span class="c1">##        def pars_to_B_and_u(pars):</span>
<span class="c1">##            B_tmp = np.zeros((nr_pools**2))</span>
<span class="c1">##            B_tmp[int_indices.tolist()] = pars[:len(int_indices)]</span>
<span class="c1">##            B_tmp = B_tmp.reshape((nr_pools,nr_pools))</span>
<span class="c1">##            for i in range(nr_pools):</span>
<span class="c1">##                for j in range(nr_pools):</span>
<span class="c1">##                    if not B[i,j].is_Function:</span>
<span class="c1">##                       B_tmp[i,j] = B[i,j]</span>
<span class="c1">##</span>
<span class="c1">##            u_tmp = np.zeros((nr_pools))</span>
<span class="c1">##            u_tmp[(ext_indices-nr_pools**2).tolist()]\</span>
<span class="c1">##                = pars[len(int_indices):]</span>
<span class="c1">##</span>
<span class="c1">##            for i in range(nr_pools):</span>
<span class="c1">##                if not u[i].is_Function:</span>
<span class="c1">##                    u_tmp[i] = u[i]</span>
<span class="c1">##</span>
<span class="c1">##            return B_tmp, u_tmp</span>
<span class="c1">##</span>
<span class="c1">##        ## function to minimize difference vector of Bx und -u</span>
<span class="c1">##        def g_eq(pars):</span>
<span class="c1">##            B, u = pars_to_B_and_u(pars)</span>
<span class="c1">###            print(B.sum(), u.sum())</span>
<span class="c1">##</span>
<span class="c1">##            res1 = np.abs(B @ xss + u)</span>
<span class="c1">###            res1 = np.abs(xss + pinv(B) @ u)</span>
<span class="c1">##            res2 = np.maximum(B.sum(0),0) # B compartmental?</span>
<span class="c1">##</span>
<span class="c1">##            print(res1.sum(), res2.sum()*1e12, (res1 + res2*1e12).sum())</span>
<span class="c1">##            return res1 + res2 * 1e12</span>
<span class="c1">##</span>
<span class="c1">##        lbounds = [0]*(nr_pools**2 + nr_pools)</span>
<span class="c1">##        for i in range(nr_pools):</span>
<span class="c1">##            lbounds[i*nr_pools+i] = -10</span>
<span class="c1">##</span>
<span class="c1">##        ubounds = [10]*(nr_pools**2 + nr_pools)</span>
<span class="c1">##        for i in range(nr_pools):</span>
<span class="c1">##            ubounds[i*nr_pools+i] = 0</span>
<span class="c1">##</span>
<span class="c1">##        par_indices = []</span>
<span class="c1">##        for i in range(nr_pools):</span>
<span class="c1">##            for j in range(nr_pools):</span>
<span class="c1">##                if B[i,j].is_Function:</span>
<span class="c1">##                    par_indices.append(i*nr_pools+j)</span>
<span class="c1">##        for i in range(nr_pools):</span>
<span class="c1">##            if u[i].is_Function:</span>
<span class="c1">##                par_indices.append(nr_pools**2+i)</span>
<span class="c1">##</span>
<span class="c1">##        par_indices = np.array(par_indices)</span>
<span class="c1">##        int_indices = par_indices[par_indices&lt;nr_pools**2]</span>
<span class="c1">##        ext_indices = par_indices[par_indices&gt;=nr_pools**2]</span>
<span class="c1">##</span>
<span class="c1">##        lbounds = np.array(lbounds)[par_indices.tolist()]</span>
<span class="c1">##        ubounds = np.array(ubounds)[par_indices.tolist()]</span>
<span class="c1">##</span>
<span class="c1">##        A0 = np.append(B0.reshape((nr_pools**2,)), u0)</span>
<span class="c1">##        pars0 = A0[par_indices.tolist()]</span>
<span class="c1">##</span>
<span class="c1">##        y = least_squares(</span>
<span class="c1">##            g_eq,</span>
<span class="c1">##            x0       = pars0,</span>
<span class="c1">##            verbose  = 2,</span>
<span class="c1">###            xtol     = 1e-03,</span>
<span class="c1">##            bounds   = (lbounds, ubounds)</span>
<span class="c1">##        )</span>
<span class="c1">##</span>
<span class="c1">###        print(y)</span>
<span class="c1">##        B, u = pars_to_B_and_u(y.x)</span>
<span class="c1">##        return B, u</span>
<span class="c1">#</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CompartmentalSystems</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/CompartmentalSystems.smooth_reservoir_model.html">CompartmentalSystems.smooth_reservoir_model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/CompartmentalSystems.smooth_model_run.html">CompartmentalSystems.smooth_model_run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/CompartmentalSystems.start_distributions.html">CompartmentalSystems.start_distributions</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Holger Metzler, Markus Mller.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>